<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <!-- leaflet cdn -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

    <style>
        body {
            margin: 0%;
            box-sizing: border-box;
            display: flex;
            flex-direction: row;
            justify-content: center;
            height: 100vh;
            background: rgb(17, 17, 17);

        }

        label {
            font-size: 1.3rem;
        }

        input[type=file] {
            opacity: .4;
            /* background: red; */
        }

        #profile img {
            /* height: 4rem;
            width: 4rem; */
            /* background-image: url("/locs;imgs/track/mainImg.png"); */
            background-position: center;
            /* background-size: contain; */
            background-size: cover;
            /* background-size: auto; */

            height: 80%;
            width: 100%;
            /* background: red; */
        }


        /*  */
        #map {
            height: 50vh;
            width: 50vw;
        }

        #addingCoords {
            background: green;
            padding: 1rem;
        }


        /* profile */
        #profile {
            min-height: 100%;
            width: 30%;
            background: rgb(206, 206, 206);
        }

        /* main */
        #main {
            height: 24%;
            background: rgb(230, 230, 230);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #imgCont {
            height: 80%;
            width: 90%;
            overflow: hidden;
            /* box-sizing: border-box; */
        }

        /* log */
        #log {
            display: flex;
            flex-direction: column;
            gap: .3rem;
        }

        #conts {
            height: 20vh;
            width: 100%;
            background: rgb(223, 223, 223);
            display: flex;
            flex-direction: row;
            gap: .4rem;
        }

        /* input fields */
        #input {
            display: flex;
        }

        #forms {}

        form {
            padding: 1rem;
            background: rgb(105, 255, 105);
            margin: 1rem;
        }
    </style>
</head>

<body>

    <div id="one">

        <!-- display conts to be confirmed -->
        <div id="conts"></div>
        <div id="input">

            <!-- map -->
            <div id="map"></div>

            <!-- form button method -->
            <div id="forms">
                <!-- adding loc -->
                <!-- <form action="/locsF" method="POST" enctype="multipart/form-data" id="addingLoc"> -->
                <input type="text" id="title" name="title" placeholder="title">
                <input type="text" id="etitle" name="etitle" placeholder="etitle">
                <label for="loc">اضافة محطة</label>
                <input type="file" id="locImg" name="loc">
                <button id="sendLoc">send loc</button>
                <!-- <input type="submit" id="send"> -->
                <!-- </form> -->

                <!-- adding per -->
                <!-- <form action="/perF" method="POST" enctype="multipart/form-data" id="addingPer">
                    <input type="text" id="title" name="title">
                    <label for="per">اضافة درة</label>

                    <input type="file" id="per" name="per">
                    <input type="submit" id="send">
                </form> -->

                <!-- adding conts  -->
                <!-- <form action="/locsF" method="POST" enctype="multipart/form-data" id="addingConts">
                    <input type="text" id="title" name="title">
                    <label for="cont">اضافة مشاركة</label>

                    <input type="file" id="cont" name="cont">
                    <input type="submit" id="send">
                </form> -->
            </div>

        </div>

        <!-- adding coordinates -->
        <button id="addingCoords">adding label</button>

    </div>
    <div id="profile">
        <div id="main">
            <h2 id="mainTitle">the mosque name</h2>
            <div id="imgCont">
                <img alt="" id="locImgTemp">

            </div>
            <!-- <div id="locTitle"></div>
            <img src="" alt="" id="mainImg"> -->
        </div>
        <div id="log"></div>
    </div>

    <!-- <div id="two">
    </div> -->

    <!-- <script> /// a try to prevent form redirecting after submitting
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }
    </script> -->



    <script>
        ///////////////////////////////////////////////////////////////////////
        ////setting up 

        const map = L.map('map').setView([36.238708, 42.496588], 13); //leaflet basic map
        //tile layer
        const apiKey = 'pk.eyJ1IjoiYWxmcmVkMjAxNiIsImEiOiJja2RoMHkyd2wwdnZjMnJ0MTJwbnVmeng5In0.E4QbAFjiWLY8k3AFhDtErA';

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: apiKey
        }).addTo(map);



        ////////defining the objects
        let oldIcon = L.icon({
            iconUrl: "https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",
            shadowSize: [50, 64], // size of the shadow
            shadowAnchor: [4, 62], // the same for the shadow
            iconSize: [25, 41],
            iconAnchor: [12, 41],
        });

        ////getting icon; icon is special object not just an image
        let markerIcon = L.icon({
            iconUrl: "https://github.com/pointhi/leaflet-color-markers/blob/master/img/marker-icon-2x-red.png?raw=true",
            shadowSize: [50, 64], // size of the shadow
            shadowAnchor: [4, 62], // the same for the shadow
            iconSize: [25, 41],
            iconAnchor: [12, 41],
        });


        /////DOM elements 

        let sendLoc = document.querySelector("#sendLoc")
        let sendCont = document.querySelector("#sendCont")
        let sendPer = document.querySelector("#sendPer")


        /////locs dom elements 
        let profile = document.querySelector("#profile")
        let main = document.querySelector("#main")
        let locTitle = document.querySelector("#locTitle")
        let mainImg = document.querySelector("#mainImg")
        let locImgTemp = document.querySelector("#locImgTemp")

        let title = document.querySelector("#title")
        let etitle = document.querySelector("#etitle")
        let locImg = document.querySelector("#locImg")

        let imgc = document.querySelector("#image")
        let img1 = document.querySelector("#img1")



        let imgCont = document.querySelector("#imgCont")
        let mainTitle = document.querySelector("#mainTitle")


        /////containers to deploy functionalities
        let tripleLinkedList = []
        let mobject = [] //??

        ////containers for sending locs 
        let currentCoords ////coords 

        /////container for sending pers 
        let perList = []
        let currentID


        /////containers for sending conts 





        //////////////////////features 

        ////getting data and images and insert them 
        window.onload = async () => {
            let d = await fetch("/locs")
            let pd = await d.json()
            // let pd1 = await JSON.parse(pd)
            console.log("get from locs")
            console.log(pd)


            /////makeing dom 
            pd.forEach(e => {

                // let h = document.createElement("h2")
                // h.textContent = e.title
                // mainTitle.textContent = e.title
                // locTitle.textContent = e.title
                console.log(e.path)
                // imgCont.style.background = `url(${e.path})`
                // let mainIMG = document.createElement("img")
                // mainIMG.src = `${e.path}`

                let labe = L.marker(e.coords).addTo(map)

                /////pers making 
                // e.pers.forEach(ee => {

                //     perList = []

                //     let p = document.createElement("div")
                //     p.classList.add("per")
                //     let b = document.createElement("img")
                //     b.setAttribute.id = "before"
                //     b.src = ee.b
                //     let a = document.createElement("img")
                //     a.src = ee.a
                //     a.setAttribute.id = "before"

                //     perList.push(p)
                // })

                // tripleLinkedList.push([e._id, h, mainIMG, labe, perList])
                tripleLinkedList.push([e._id, e.title, e.path, labe, perList])

                ////inserting the created dom on the template; on eventlistener 

                labe.addEventListener("click", (e) => {

                    console.log(tripleLinkedList)

                    tripleLinkedList.forEach(tr => {
                        if (tr[3] == e.target) {
                            console.log(e.target)
                            console.log(tr)

                            locImgTemp.style.backgroundImage = `url(${tr[2]})`
                            locImgTemp.style.backgroundSize = "cover"
                            locImgTemp.style.backgroundPosition = "center"

                            mainTitle.textContent = tr[1]
                            // main.removeChild()
                            // main.innerHTML = ""
                            // main.append(tr[1], tr[2])

                            currentID = tr[0]

                            // main.append(...tr[3])    //for pers appending 
                        }
                    })
                })
            })

            // img1.src = `${pd}`

        }


        // adding coordinates; 

        let addCoords = document.querySelector("#addingCoords")
        addCoords.onclick = () => {
            console.log("clicked on add coords button")
            addCoords.classList.toggle("on")
            console.log(mobject)
        }

        map.addEventListener('click', function (ev) {
            if (addCoords.classList.contains("on")) {
                let latlng = map.mouseEventToLatLng(ev.originalEvent);
                let i = [latlng.lat, latlng.lng]
                let m = L.marker(i, {
                    icon: oldIcon
                }).addTo(map);
                mobject.push(m)

                ////object eventlistender
                m.addEventListener("click", (e) => {
                    // console.log(e)
                    mobject.forEach(ee => {
                        ee.setIcon(oldIcon)
                    })
                    e.target.setIcon(markerIcon)
                    currentCoords = e.target._latlng
                    console.log(currentCoords)
                })

                ////containers set
                currentCoords = i
            }
        });






        //////////////POST data 

        /////xmlhttprequest and formdata 

        let xml = new XMLHttpRequest()
        let fd = new FormData()



        ////////////////////mdn code 
        /////xhr xmlhttprequest formData 
        // const btn = document.querySelector('button');

        // function sendData(data) {
        //     const XHR = new XMLHttpRequest(),
        //         FD = new FormData();

        //     // Push our data into our FormData object
        //     for (name in data) {
        //         FD.append(name, data[name]);
        //     }
        //     // FD.append(imgc.files[0])
        //     // FD.append('userpic', imgc.files[0], 'chris.jpg');


        //     // Define what happens on successful data submission
        //     XHR.addEventListener('load', function (event) {
        //         alert('Yeah! Data sent and response loaded.');
        //     });

        //     // Define what happens in case of error
        //     XHR.addEventListener(' error', function (event) {
        //         alert('Oops! Something went wrong.');
        //     });

        //     // Set up our request
        //     XHR.open('POST', 'upl');

        //     // Send our FormData object; HTTP headers are set automatically
        //     XHR.send(FD);
        // }




        sendLoc.addEventListener("click", async () => {


            ///appending the intended data 
            // fd.append("coords", JSON.stringify(currentCoords))
            fd.append("coords", currentCoords)
            fd.append("title", title.value)
            fd.append("etitle", etitle.value)
            fd.append("image", locImg.files[0])

            // let p = fetch("/locs", {
            //     method: "POST",
            //     headers: {
            //         'Accept': 'application/json',
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify({
            //         coords: currentCoords
            //     })
            // })

            /////check if there is a missing value 
            console.log(currentCoords)
            console.log(title.value)
            console.log(etitle.value)
            console.log(locImg.files[0])

            console.log(fd)

            /////sending xml formdata 
            if (currentCoords != "" && title.value != "" && etitle.value != "" && locImg.files != null) {
                xml.open("POST", "/locs")
                xml.send(fd)
            }


            currentCoords = ""
            title.value = ""
            etitle.value = ""
            locImg.files = null

            console.log(locImg.files)

            /////empty the data containers 

            // if (currentCoords != [] || ) {

            // } else {}

            // let d = await fetch('locs', {
            //     method: 'POST',
            //     headers: {
            //         'Accept': 'application/json',
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify({
            //         coords: currentCoords
            //     })
            // });

        })




        // send.addEventListener('click', function () {
        //     sendData({
        //         test: 'ok',
        //         file: imgc.files[0]
        //     });
        // })





        ///////////////test code 

        window.onclick = () => {
            // console.log(currentCoords)
            // console.log(currentID)
            // console.log(title.value)
            // console.log(imgc.files)
        }


        /////have trouble appending on the server side to identify that this is file 
    </script>
</body>

</html>