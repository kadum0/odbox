<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <!-- leaflet cdn -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

    <style>
        body {
            margin: 0%;
            box-sizing: border-box;
            display: flex;
            flex-direction: row;
            justify-content: center;
            height: 100vh;
            background: rgb(17, 17, 17);
            /* box-sizing: border-box; */
            max-width: 100vw;
            /* overflow-x: hidden; */
        }

        label {
            font-size: 1.3rem;
        }

        input[type=file] {
            opacity: .4;
            /* background: red; */
        }

        #profile img {
            /* height: 4rem;
            width: 4rem; */
            /* background-image: url("/locs;imgs/track/mainImg.png"); */
            background-position: center;
            /* background-size: contain; */
            background-size: cover;
            /* background-size: auto; */

            height: 80%;
            width: 100%;
            /* background: red; */
        }


        /*  */
        #map {
            height: 50vh;
            width: 50vw;
        }

        #addingCoords {
            background: green;
            padding: 1rem;
        }


        /* profile */
        #profile {
            min-height: 100%;
            width: 30%;
            background: rgb(206, 206, 206);
        }

        /* main */
        #main {
            height: 24%;
            background: rgb(230, 230, 230);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #imgCont {
            height: 80%;
            width: 90%;
            overflow: hidden;
            /* box-sizing: border-box; */
        }

        /* log */
        #log {
            display: flex;
            flex-direction: column;
            gap: .3rem;
        }


        /* input fields */
        #input {
            display: flex;
        }

        #forms {}

        .form {
            padding: 1rem;
            background: rgb(105, 255, 105);
            margin: 1rem;
        }

        /* conts */
        #conts {
            min-height: 22vh;
            max-width: 78vw;
            background: rgb(223, 223, 223);
            display: flex;
            flex-direction: row;
            gap: .4rem;
            padding: 1rem;
            overflow-x: scroll;
        }


        .con {
            min-height: 5rem;
            min-width: 8rem;
            padding-bottom: 1rem;
        }

        .con img {
            background: url("./conts/newading/2022-04-21T14-56-45.458Zdcf96b9a-ba88-46cc-96ef-54d2e3f14507_rwc_0x303x1677x261x1677\ -\ Copy.png");
            background-size: cover;
            background-position: center;
            height: 100%;
            width: 100%;

        }

        .con .accept {
            background: green;
        }

        .con .refuse {
            background: red;
        }
    </style>
</head>

<body>

    <div id="one">

        <!-- display conts to be confirmed -->
        <div id="conts">
            <!-- <div class="con">
                <img alt="">
                <button class="accept">accept</button>
                <button class="refuse">refuse</button>
            </div>
            <div class="con">
                <img alt="">
                <button class="accept">accept</button>
                <button class="refuse">refuse</button>
            </div> -->

        </div>
        <div id="input">

            <!-- map -->
            <div id="map"></div>

            <!-- form button method -->
            <div id="forms">
                <!-- adding loc -->
                <!-- <form action="/locsF" method="POST" enctype="multipart/form-data" id="addingLoc"> -->
                <div class="form" id="addingLocs">
                    <input type="text" id="title" name="title" placeholder="title">
                    <input type="text" id="etitle" name="etitle" placeholder="etitle">
                    <label for="loc">اضافة محطة</label>
                    <input type="file" id="locImg" name="loc">
                    <button id="sendLoc">send loc</button>
                </div>
                <!-- <input type="submit" id="send"> -->
                <!-- </form> -->

                <!-- adding per -->
                <!-- <form action="/perF" method="POST" enctype="multipart/form-data" id="addingPer">
                    <input type="text" id="title" name="title">
                    <label for="per">اضافة درة</label>

                    <input type="file" id="per" name="per">
                    <input type="submit" id="send">
                </form> -->

                <!-- adding conts  -->

                <div class="form" id="addingConts">
                    <!-- <form action="/conts" method="POST"> -->
                    <label for="contImg">اضافة مشاركة</label>
                    <input type="file" id="contImg" name="Cont" multiple>
                    <!-- <input type="submit"> -->
                    <!-- </form> -->
                    <!-- <input type="text" id="titleCont" name="title" placeholder="title"> -->
                    <!-- <input type="text" id="etitleCont" name="etitle" placeholder="etitle"> -->
                    <button id="sendCont">send conts</button>
                </div>

                <div class="form" id="addingDist">
                    <label for="distBImg">اضافة صورة قبل</label>
                    <input type="file" id="distBImg" name="distBImg">
                    <label for="distAImg">اضافة صورة بعد</label>
                    <input type="file" id="distAImg" name="distAImg">
                    <input type="text" id="distInfo" placeholder="info">
                    <button id="sendDist"> send dist</button>
                </div>

                <!-- <form action="/locsF" method="POST" enctype="multipart/form-data" id="addingConts">
                    <input type="text" id="title" name="title">
                    <label for="cont">اضافة مشاركة</label>

                    <input type="file" id="cont" name="cont">
                    <input type="submit" id="send">
                </form> -->
            </div>

        </div>

        <!-- adding coordinates -->
        <button id="addingCoords">adding label</button>

    </div>
    <div id="profile">
        <div id="main">
            <h2 id="mainTitle">the mosque name</h2>
            <div id="imgCont">
                <img alt="" id="locImgTemp">

            </div>
        </div>
        <div id="log"></div>
    </div>

    <script>
        ///////////////////////////////////////////////////////////////////////
        ////setting up 

        const map = L.map('map').setView([36.238708, 42.496588], 13); //leaflet basic map
        //tile layer
        const apiKey = 'pk.eyJ1IjoiYWxmcmVkMjAxNiIsImEiOiJja2RoMHkyd2wwdnZjMnJ0MTJwbnVmeng5In0.E4QbAFjiWLY8k3AFhDtErA';

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: apiKey
        }).addTo(map);



        ////////defining the objects
        let oldIcon = L.icon({
            iconUrl: "https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",
            shadowSize: [50, 64], // size of the shadow
            shadowAnchor: [4, 62], // the same for the shadow
            iconSize: [25, 41],
            iconAnchor: [12, 41],
        });

        ////getting icon; icon is special object not just an image
        let markerIcon = L.icon({
            iconUrl: "https://github.com/pointhi/leaflet-color-markers/blob/master/img/marker-icon-2x-red.png?raw=true",
            shadowSize: [50, 64], // size of the shadow
            shadowAnchor: [4, 62], // the same for the shadow
            iconSize: [25, 41],
            iconAnchor: [12, 41],
        });


        /////DOM elements 

        ///locs
        let sendLoc = document.querySelector("#sendLoc")
        let title = document.querySelector("#title")
        let etitle = document.querySelector("#etitle")
        let locImg = document.querySelector("#locImg")

        ///conts
        let contImgs = document.querySelector("#contImg")
        let sendCont = document.querySelector("#sendCont")

        ///dist
        let distBImg = document.querySelector("#distBImg")
        let distAImg = document.querySelector("#distAImg")
        let distInfo = document.querySelector("#distInfo")
        let sendDist = document.querySelector("#sendDist")


        /////template dom elements 
        let locImgTemp = document.querySelector("#locImgTemp")
        let imgCont = document.querySelector("#imgCont")
        let mainTitle = document.querySelector("#mainTitle")
        let conts = document.querySelector("#conts")

        let profile = document.querySelector("#profile") ///no need
        let main = document.querySelector("#main") ///no need
        let locTitle = document.querySelector("#locTitle") ///no need
        let mainImg = document.querySelector("#mainImg") ///no need
        let imgc = document.querySelector("#image") ///no need
        let img1 = document.querySelector("#img1") ///no need







        /////containers to deploy functionalities
        let tripleLinkedList = []
        let mobject = [] //??

        ////containers for sending locs 
        let currentCoords ////coords 
        let currentEtitle

        /////container for sending pers 
        let perList = []
        let currentID ////no need 
        let displayedContImgs = []
        let acceptedConts = []
        let refusedConts = []

        let filesCounter = 0

        /////containers for sending conts 

        /// ///per (dist) ////not to create the objects to send that need to be
        /// done when get send for it to get empty and not duplicated in case of
        /// sending request after a request 
        // let distObject = {}
        // let perObject



        //////////////////////features 

        ////getting data and images and insert them 
        window.onload = async () => {
            let d = await fetch("/locs")
            let pd = await d.json() ///or JSON.parse(pd)
            console.log("get from locs")
            console.log(pd)

            /////makeing dom 
            pd.forEach(e => {
                /////coords; lables
                let labe = L.marker(e.coords).addTo(map)
                console.log(e.conts)

                /////creating conts imgs and inserting them 
                e.conts.forEach(mg => {

                    let con = document.createElement("div")
                    con.classList.add("con")

                    let img = document.createElement("img")
                    img.style.backgroundImage = `url(${mg})`
                    img.style.backgroundSize = "cover"
                    img.style.backgroundPosition = "center"
                    img.setAttribute("data-imgPath", mg)

                    let acceptBtn = document.createElement("button")
                    acceptBtn.classList.add("accept")
                    acceptBtn.textContent = "accept"

                    let refurseBtn = document.createElement("button")
                    refurseBtn.classList.add("refuse")
                    refurseBtn.textContent = "refuse"

                    con.append(img, acceptBtn, refurseBtn)


                    displayedContImgs.push(con)

                    //////functionality (eventlistener)
                    con.addEventListener("click", (event) => {

                        if (event.target.classList.contains("accept")) {

                            tripleLinkedList.forEach(nu => {
                                nu[6].forEach(nu2 => {
                                    if (nu2 == event.target
                                        .parentElement.children[0]
                                        .getAttribute("data-imgPath")) {
                                        acceptedConts.push(event.target
                                            .parentElement.children[
                                                0].getAttribute(
                                                "data-imgPath"))
                                    }
                                })
                            })

                        }
                        if (event.target.classList.contains("refuse")) {

                            tripleLinkedList.forEach(nu => {
                                nu[6].forEach(nu2 => {
                                    if (nu2 == event.target
                                        .parentElement.children[0]
                                        .getAttribute("data-imgPath")) {
                                        refusedConts.push(event.target
                                            .parentElement.children[
                                                0].getAttribute(
                                                "data-imgPath"))
                                    }
                                })
                            })

                        }


                    })
                })

                /////linked list
                tripleLinkedList.push([e._id, e.etitle, e.title, e.path, labe, perList,
                    displayedContImgs
                ])

                ////inserting the created dom on the template; on eventlistener 
                labe.addEventListener("click", (e) => {

                    tripleLinkedList.forEach(tr => {
                        if (tr[4] == e.target) {
                            locImgTemp.style.backgroundImage = `url(${tr[3]})`
                            locImgTemp.style.backgroundSize = "cover"
                            locImgTemp.style.backgroundPosition = "center"

                            mainTitle.textContent = tr[2]

                            tr[6].forEach(trImg => {
                                conts.append(trImg)
                            })

                            // currentID = tr[0]
                            currentEtitle = tr[1]
                        }
                    })
                })

            })
        }




        // adding coordinates; 

        let addCoords = document.querySelector("#addingCoords")
        addCoords.onclick = () => {
            addCoords.classList.toggle("on")
        }

        map.addEventListener('click', function (ev) {
            if (addCoords.classList.contains("on")) {
                let latlng = map.mouseEventToLatLng(ev.originalEvent);
                let i = [latlng.lat, latlng.lng]
                let m = L.marker(i, {
                    icon: oldIcon
                }).addTo(map);
                mobject.push(m)

                ////object eventlistender
                m.addEventListener("click", (e) => {
                    mobject.forEach(ee => {
                        ee.setIcon(oldIcon)
                    })
                    e.target.setIcon(markerIcon)
                    currentCoords = e.target._latlng
                })
                currentCoords = i

                ////select current etitle

            }
        });






        //////////////POST; send data 

        /////xmlhttprequest and formdata 

        let xml = new XMLHttpRequest()

        /////send loc
        sendLoc.addEventListener("click", async () => {

            let fd = new FormData()

            ///appending the intended data to the formData
            fd.append("coords", currentCoords)
            fd.append("title", title.value)
            fd.append("etitle", etitle.value)
            fd.append("image", locImg.files[0])

            /////check if there is a missing value 
            console.log(currentCoords)
            console.log(title.value)
            console.log(etitle.value)
            console.log(locImg.files[0])

            console.log(fd)

            /////sending xml formdata 
            ///////check if valid (not empty)
            if (currentCoords != undefined && title.value != "" && etitle.value != "" &&
                locImg.files != null) {
                /////xml method; 
                // xml.open("POST", "/locs")
                // xml.send(fd)

                let d = await fetch("/locs", {
                    method: "POST",
                    body: fd
                })

                /////empty the data containers 
                currentCoords = undefined
                // title.value = undefined
                title.value = ""
                // etitle.value = undefined
                etitle.value = ""
                locImg.files = null
                console.log(locImg.files)
            }
        })

        ////send cont
        sendCont.onclick = async () => {

            let fdCont = new FormData()

            fdCont.append("etitle", currentEtitle)
            for (let i of contImgs.files) {
                fdCont.append(`Cont`, i);
                console.log(i)
            }
            console.log(fdCont)
            console.log(currentEtitle)


            if (currentEtitle != undefined && contImgs.files != undefined) {

                // xml.open("POST", "/conts")
                // xml.send(fdCont)

                let d = await fetch("/conts", {
                    method: "POST",
                    // data: fdCont,
                    body: fdCont
                })
            }
        }


        /////send dist; 
        sendDist.addEventListener("click", async () => {

            console.log(distInfo.value)

            if (distBImg.files[0] && distAImg.files[0] && distInfo.value) {

                let distObject = {}

                distObject.B = distBImg.files[0]
                distObject.A = distAImg.files[0]
                distObject.info = distInfo.value
                distObject.acceptedConts = acceptedConts
                distObject.refusedConts = refusedConts
                distObject.data = new Date()
                distObject.locTitle = currentEtitle

                let fdDist = new FormData()
                fdDist.append("B", distBImg.files[0])
                fdDist.append("A", distAImg.files[0])
                fdDist.append("date", new Date())
                fdDist.append("info", distInfo.value)
                fdDist.append("acceptedConts", acceptedConts)
                fdDist.append("refusedConts", refusedConts)
                fdDist.append("loc-etitle", currentEtitle)

                // await fetch("dist", {
                //     method: "POST",
                //     body: fdDist
                // })

                console.log(fdDist)
                console.log(distObject)

                /////empty the containers; 
                distBImg.files[0] = null
                distAImg.files[0] = null
                distInfo.value = ""



            }


            // console.log(distObject)

        })


        ////for sending rules; 
        ///make sure (check) the containers if they contain data 
        ///make an object and insert the data in
        ///empty the containers value 


        ///////////////test code 

        window.onclick = () => {
            // console.log(currentCoords)
            // console.log(currentID)
            // console.log(title.value)
            // console.log(imgc.files)
        }
    </script>
</body>

</html>